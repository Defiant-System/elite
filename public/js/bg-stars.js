let Stars={init(){this.paused=false;this.TAU=Math.PI*2;this.speed=.2;this.inertia=5;this.stars={view:null,angle:0,velocity:{x:0,y:0,z:0},min:.2,max:1.5,threshold:50,count:128,list:[]};this.cruise={minSpeed:.2,count:7,l1:[],l2:[]}},dispatch(e){let t=Stars,a;switch(e.type){case"start":t.cvs=e.canvas;t.ctx=t.cvs.getContext("2d");t.width=t.cvs.width;t.height=t.cvs.height;t.center={x:t.width>>1,y:t.height>>1};t.target={...t.center};t.focal={...t.center};t.cruise.step=(t.focal.x+60)/t.cruise.count;t.dispatch({type:"view-front"});t.dispatch({type:"create-scene"});t.draw();break;case"pause":t.paused=true;break;case"resume":if(t.paused&&t.ctx){t.paused=false;t.draw()}break;case"view-front":t.stars.view=e.type.split("-")[1];t.stars.velocity={x:0,y:0,z:t.speed*.025};if(!e.update)t.dispatch({type:"create-scene"});break;case"view-back":t.stars.view=e.type.split("-")[1];t.stars.velocity={x:0,y:0,z:-t.speed*.025};if(!e.update)t.dispatch({type:"create-scene"});break;case"view-up":t.stars.view=e.type.split("-")[1];t.stars.velocity={x:0,y:t.speed*2,z:0};if(!e.update)t.dispatch({type:"create-scene"});break;case"view-down":t.stars.view=e.type.split("-")[1];t.stars.velocity={x:0,y:-t.speed*2,z:0};if(!e.update)t.dispatch({type:"create-scene"});break;case"view-left":t.stars.view=e.type.split("-")[1];t.stars.velocity={x:t.speed*2,y:0,z:0};if(!e.update)t.dispatch({type:"create-scene"});break;case"view-right":t.stars.view=e.type.split("-")[1];t.stars.velocity={x:-t.speed*2,y:0,z:0};if(!e.update)t.dispatch({type:"create-scene"});break;case"thrust":t.speed=Math.min(t.speed+.1,1);t.dispatch({type:`view-${t.stars.view}`,update:true});break;case"brake":t.speed=Math.max(t.speed-.1,.15);t.dispatch({type:`view-${t.stars.view}`,update:true});break;case"roll-left":t.stars.rotate=e.state?1.25*(Math.PI/180):null;break;case"roll-right":t.stars.rotate=e.state?-1.25*(Math.PI/180):null;break;case"dive":t.target=e.state?{x:t.width>>1,y:t.height*3.5}:t.center;break;case"climb":t.target=e.state?{x:t.width>>1,y:-t.height*2.5}:t.center;break;case"set-focal-point":t.target={x:e.x,y:e.y};break;case"create-scene":t.stars.list=[...Array(t.stars.count)].map((e=>({x:Utils.random(0,t.width),y:Utils.random(0,t.height),z:Utils.random(t.stars.min,t.stars.max)})));break;case"super-cruise-on":t.cruise.l1=[...Array(t.cruise.count)].map(((e,a)=>({x:-a*t.cruise.step,z:.5})));t.cruise.l2=[...Array(t.cruise.count)].map(((e,a)=>({x:-a*t.cruise.step,z:.5})));break;case"super-cruise-off":if(t.speed>t.cruise.minSpeed){t.speed=t.cruise.minSpeed;t.dispatch({type:`look-${t.stars.view}`,update:true})}t.cruise.l1=[];t.cruise.l2=[];break}},recycle(e={}){let t=this,a=t.stars.velocity,s=t.stars.threshold,r=t.stars.view,i=(e,a)=>{switch(a){case"left":e.x=-s;e.y=Utils.random(0,t.height);break;case"right":e.x=t.width+s;e.y=Utils.random(0,t.height);break;case"up":e.x=Utils.random(0,t.width);e.y=-s;break;case"down":e.x=Utils.random(0,t.width);e.y=t.height+s;break}};e.z=Utils.random(t.stars.min,t.stars.max);switch(r){case"front":e.x=Utils.random(0,t.width);e.y=Utils.random(0,t.height);if(e.z>.35)e.z-=.3;break;case"back":e.x=Utils.random(0,t.width);e.y=Utils.random(0,t.height);break;case"left":case"right":case"up":case"down":i(e,r);break}return e},update(e){let t=e.stars.velocity,a=e.stars.threshold,s=e.focal.x,r=e.focal.y,i=e.target.x-e.focal.x,c=e.target.y-e.focal.y;e.focal.x+=i/e.inertia;e.focal.y+=c/e.inertia;e.stars.list.map((s=>{if(!!e.stars.rotate){let t=e.focal.x,a=e.focal.y,r=Math.atan2(s.y-a,s.x-t),i=Utils.calculateDistance(t,a,s.x,s.y);s.x=t+i*Math.cos(r+e.stars.rotate);s.y=a+i*Math.sin(r+e.stars.rotate)}s.x+=t.x*s.z;s.y+=t.y*s.z;s.x+=(s.x-e.focal.x)*t.z*s.z;s.y+=(s.y-e.focal.y)*t.z*s.z;s.z+=t.z;if(s.x<-a||s.x>e.width+a||s.y<-a||s.y>e.height+a||s.z<0){e.recycle(s)}}));if(e.stars.view==="front"&&e.cruise.l1.length){e.cruise.l1.map((t=>{t.x+=(t.x-e.focal.x)*e.speed*25e-6*t.z;t.z+=e.speed*.45;t.a=t.z*e.speed*.0025;if(t.x<-e.focal.x){t.a=0;t.x=0;t.z=.15}}));e.cruise.l2.map((t=>{t.x+=(t.x-e.focal.x)*e.speed*25e-6*t.z;t.z+=e.speed*2;t.a=t.z*e.speed*.001;if(t.x<-e.focal.x){t.a=0;t.x=0;t.z=.15}}))}},draw(){let e=Stars,t=e.ctx,a=e.stars.max,s=e.stars.view==="back"?.45:0,r=Date.now();if(!e.paused)requestAnimationFrame(e.draw);if(r-e.then<50)return;e.then=r;e.cvs.width=e.width;e.update(e);e.stars.list.map((r=>{let i=r.z*.85,c=i/a+s,l=255-Math.round((a-i)*255);t.beginPath();t.fillStyle=`rgba(${l},${l},${l},${c})`;t.arc(r.x,r.y,i,0,e.TAU);t.fill()}));if(e.stars.view==="front"&&e.cruise.l1.length){t.save();t.translate(0,e.height*.5);t.lineWidth=1;[...e.cruise.l1,...e.cruise.l2].map((a=>{let s=a.x+(e.focal.x-150),r=80-s*70/e.focal.y;t.strokeStyle=`rgba(255,255,255,${a.a})`;t.beginPath();t.moveTo(s,-r);t.lineTo(s,r);t.stroke();t.beginPath();t.moveTo(e.width-s,-r);t.lineTo(e.width-s,r);t.stroke()}));t.restore()}}};Stars.init();self.onmessage=e=>Stars.dispatch(e.data);let Utils={random(e,t){return Math.random()*(t-e)+e},calculateDistance(e,t,a,s){let r=e-a,i=t-s;return Math.sqrt(r**2+i**2)}};